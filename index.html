<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arico Shop Online - Thương mại điện tử</title>
    
    <!-- Bootstrap 5.3.3 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        /* Custom CSS cho website */
        :root {
            --primary-color: #f8bbd0;
            --secondary-color: #90caf9;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .product-card {
            transition: transform 0.3s ease-in-out;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .product-image {
            height: 200px;
            object-fit: cover;
            background-color: #f8f9fa;
        }

        .cart-badge {
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.8rem;
            position: absolute;
            top: -8px;
            right: -8px;
        }

        .filter-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .cart-item {
            border-bottom: 1px solid #dee2e6;
            padding: 15px 0;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .order-summary {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 50px;
        }

        .admin-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .tracking-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .review-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .stars {
            color: #ffc107;
        }

        .footer {
            background-color: #343a40;
            color: white;
            padding: 40px 0;
            margin-top: 50px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="showPage('home')">
                <i class="bi bi-shop"></i> Arico Shop Online
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('home')">Trang chủ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('products')">Sản phẩm</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('tracking')">Tra cứu đơn hàng</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showPage('admin')" id="adminLink" style="display: none;">Quản trị</a>
                    </li>
                </ul>
                
                <div class="d-flex">
                    <button class="btn btn-outline-light position-relative me-2" onclick="showPage('cart')">
                        <i class="bi bi-cart"></i> Giỏ hàng
                        <span class="cart-badge" id="cartBadge">0</span>
                    </button>
                    <button class="btn btn-outline-light" onclick="toggleAdmin()">
                        <i class="bi bi-person-gear"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
        </div>
        <p class="mt-3">Đang tải dữ liệu...</p>
    </div>

    <!-- Home Page -->
    <div id="homePage" class="page-section active">
        <div class="container mt-4">
            <!-- Hero Section -->
            <div class="row mb-5">
                <div class="col-12">
                    <div class="bg-primary text-white rounded-3 p-5 text-center">
                        <h1 class="display-4 fw-bold">Chào mừng đến với Arico Shop Online</h1>
                        <p class="lead">Khám phá hàng ngàn sản phẩm chất lượng với giá tốt nhất</p>
                        <button class="btn btn-light btn-lg" onclick="showPage('products')">
                            Mua sắm ngay <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Featured Products -->
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4">Sản phẩm nổi bật</h2>
                    <div class="row" id="featuredProducts">
                        <!-- Featured products sẽ được load bằng JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Page -->
    <div id="productsPage" class="page-section">
        <div class="container mt-4">
            <!-- Filters -->
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Tìm kiếm</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Nhập tên sản phẩm...">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Danh mục</label>
                        <select class="form-select" id="categoryFilter">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Giá từ</label>
                        <input type="number" class="form-control" id="minPrice" placeholder="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Giá đến</label>
                        <input type="number" class="form-control" id="maxPrice" placeholder="999999">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Sắp xếp</label>
                        <select class="form-select" id="sortBy">
                            <option value="name">Tên A-Z</option>
                            <option value="price-asc">Giá tăng dần</option>
                            <option value="price-desc">Giá giảm dần</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="filterProducts()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="row" id="productsGrid">
                <!-- Products sẽ được load bằng JavaScript -->
            </div>
        </div>
    </div>

    <!-- Cart Page -->
    <div id="cartPage" class="page-section">
        <div class="container mt-4">
            <h2 class="mb-4">Giỏ hàng của bạn</h2>
            
            <div class="row">
                <div class="col-lg-8">
                    <div class="bg-white rounded-3 p-4">
                        <div id="cartItems">
                            <!-- Cart items sẽ được load bằng JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="order-summary">
                        <h4>Tóm tắt đơn hàng</h4>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tạm tính:</span>
                            <span id="subtotal">0 ₫</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Phí vận chuyển:</span>
                            <span id="shipping">30,000 ₫</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Tổng cộng:</strong>
                            <strong id="total">0 ₫</strong>
                        </div>
                        
                        <button class="btn btn-success w-100 mb-2" onclick="showCheckout()" id="checkoutBtn">
                            Tiến hành thanh toán
                        </button>
                        <button class="btn btn-outline-primary w-100" onclick="showPage('products')">
                            Tiếp tục mua sắm
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Page -->
    <div id="checkoutPage" class="page-section">
        <div class="container mt-4">
            <h2 class="mb-4">Thanh toán</h2>
            
            <div class="row">
                <div class="col-lg-8">
                    <div class="bg-white rounded-3 p-4 mb-4">
                        <h4>Thông tin người nhận</h4>
                        <form id="checkoutForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Họ và tên *</label>
                                    <input type="text" class="form-control" id="customerName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Số điện thoại *</label>
                                    <input type="tel" class="form-control" id="customerPhone" required>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="customerEmail">
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Địa chỉ giao hàng *</label>
                                    <textarea class="form-control" id="customerAddress" rows="3" required></textarea>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Ghi chú</label>
                                    <textarea class="form-control" id="orderNote" rows="2" placeholder="Ghi chú thêm cho đơn hàng..."></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <div class="bg-white rounded-3 p-4">
                        <h4>Phương thức thanh toán</h4>
                        <div class="alert alert-info">
                            <h5><i class="bi bi-bank"></i> Chuyển khoản ngân hàng</h5>
                            <p class="mb-1"><strong>Ngân hàng:</strong> Vietcombank</p>
                            <p class="mb-1"><strong>Số tài khoản:</strong> 1234567890</p>
                            <p class="mb-1"><strong>Chủ tài khoản:</strong> NGUYEN VAN A</p>
                            <p class="mb-0"><strong>Nội dung:</strong> <span id="transferContent">Thanh toán đơn hàng #</span></p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="order-summary">
                        <h4>Đơn hàng của bạn</h4>
                        <hr>
                        <div id="checkoutItems">
                            <!-- Checkout items sẽ được load bằng JavaScript -->
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tạm tính:</span>
                            <span id="checkoutSubtotal">0 ₫</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Phí vận chuyển:</span>
                            <span>30,000 ₫</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Tổng cộng:</strong>
                            <strong id="checkoutTotal">0 ₫</strong>
                        </div>
                        
                        <button class="btn btn-success w-100" onclick="confirmPayment()">
                            <i class="bi bi-check-circle"></i> Xác nhận đã thanh toán
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Success Page -->
    <div id="orderSuccessPage" class="page-section">
        <div class="container mt-4">
            <div class="text-center">
                <div class="mb-4">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                </div>
                <h2 class="text-success mb-3">Đặt hàng thành công!</h2>
                <p class="lead mb-4">Cảm ơn bạn đã đặt hàng. Chúng tôi sẽ liên hệ với bạn sớm nhất.</p>
                
                <div class="bg-light rounded-3 p-4 mb-4" style="max-width: 500px; margin: 0 auto;">
                    <h4>Thông tin đơn hàng</h4>
                    <p class="mb-1"><strong>Mã đơn hàng:</strong> <span id="orderCode" class="text-primary"></span></p>
                    <p class="mb-1"><strong>Tổng tiền:</strong> <span id="orderAmount"></span></p>
                    <p class="mb-0"><strong>Thời gian:</strong> <span id="orderTime"></span></p>
                </div>
                
                <div class="mb-4">
                    <button class="btn btn-primary me-2" onclick="showPage('tracking')">
                        Tra cứu đơn hàng
                    </button>
                    <button class="btn btn-outline-primary" onclick="showPage('products')">
                        Tiếp tục mua sắm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tracking Page -->
    <div id="trackingPage" class="page-section">
        <div class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="tracking-card">
                        <h2 class="text-center mb-4">Tra cứu đơn hàng</h2>
                        
                        <div class="mb-4">
                            <label class="form-label">Nhập mã đơn hàng</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="trackingInput" placeholder="Nhập mã đơn hàng...">
                                <button class="btn btn-primary" onclick="trackOrder()">
                                    <i class="bi bi-search"></i> Tra cứu
                                </button>
                            </div>
                        </div>
                        
                        <div id="trackingResult" style="display: none;">
                            <!-- Tracking result sẽ được hiển thị ở đây -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Page -->
    <div id="adminPage" class="page-section">
        <div class="container mt-4">
            <h2 class="mb-4">Quản trị hệ thống</h2>
            
            <!-- Admin Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="admin-stats text-center">
                        <h3 id="totalOrders">0</h3>
                        <p class="mb-0">Tổng đơn hàng</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="admin-stats text-center">
                        <h3 id="totalRevenue">0 ₫</h3>
                        <p class="mb-0">Doanh thu tháng</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="admin-stats text-center">
                        <h3 id="pendingOrders">0</h3>
                        <p class="mb-0">Đơn chờ xử lý</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="admin-stats text-center">
                        <h3 id="totalProducts">0</h3>
                        <p class="mb-0">Tổng sản phẩm</p>
                    </div>
                </div>
            </div>
            
            <!-- Admin Controls -->
            <div class="row">
                <div class="col-md-6">
                    <div class="bg-white rounded-3 p-4">
                        <h4>Quản lý đơn hàng</h4>
                        <div class="mb-3">
                            <label class="form-label">Lọc theo trạng thái</label>
                            <select class="form-select" id="orderStatusFilter">
                                <option value="">Tất cả</option>
                                <option value="pending">Chờ xử lý</option>
                                <option value="processing">Đang xử lý</option>
                                <option value="shipped">Đã giao</option>
                                <option value="completed">Hoàn thành</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="loadAdminOrders()">
                            <i class="bi bi-refresh"></i> Tải lại dữ liệu
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="bg-white rounded-3 p-4">
                        <h4>Thống kê doanh thu</h4>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Từ ngày</label>
                                <input type="date" class="form-control" id="statsFromDate">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Đến ngày</label>
                                <input type="date" class="form-control" id="statsToDate">
                            </div>
                        </div>
                        <button class="btn btn-success mt-3" onclick="generateStats()">
                            <i class="bi bi-bar-chart"></i> Tạo báo cáo
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Orders Table -->
            <div class="bg-white rounded-3 p-4 mt-4">
                <h4>Danh sách đơn hàng</h4>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Khách hàng</th>
                                <th>Sản phẩm</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Ngày đặt</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="adminOrdersTable">
                            <!-- Orders sẽ được load bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>Về chúng tôi</h5>
                    <p>Arico Shop Online - Hệ thống thương mại điện tử uy tín, chất lượng hàng đầu Việt Nam.</p>
                </div>
                <div class="col-md-4">
                    <h5>Liên hệ</h5>
                    <p><i class="bi bi-geo-alt"></i> 123 Đường ABC, Quận 1, TP.HCM</p>
                    <p><i class="bi bi-phone"></i> 0123-456-789</p>
                    <p><i class="bi bi-envelope"></i> info@shoponline.vn</p>
                </div>
                <div class="col-md-4">
                    <h5>Hỗ trợ</h5>
                    <p><a href="#" class="text-light">Chính sách bảo hành</a></p>
                    <p><a href="#" class="text-light">Chính sách đổi trả</a></p>
                    <p><a href="#" class="text-light">Hướng dẫn mua hàng</a></p>
                </div>
            </div>
            <hr class="my-4">
            <div class="text-center">
                <p>&copy; 2025 Arico Shop Online. Tất cả quyền được bảo lưu.</p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==================== CONFIGURATION ====================
        // Cấu hình Google Apps Script Web App URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz2qNsGdmmIfoZEVz1s5WzktBV-59sUOV9BGZGmLh6q/dev';
        
        // Demo data cho việc phát triển (thay thế bằng Google Sheets API)
        let products = [
            {
                id: 1,
                name: 'iPhone 15 Pro Max',
                category: 'Điện thoại',
                price: 29990000,
                image: 'https://placehold.co/300x200?text=iPhone+15+Pro+Max',
                description: 'iPhone 15 Pro Max với chip A17 Pro mạnh mẽ',
                stock: 10,
                featured: true
            },
            {
                id: 2,
                name: 'Samsung Galaxy S24 Ultra',
                category: 'Điện thoại',
                price: 27990000,
                image: 'https://placehold.co/300x200?text=Galaxy+S24+Ultra',
                description: 'Samsung Galaxy S24 Ultra với S Pen tích hợp',
                stock: 15,
                featured: true
            },
            {
                id: 3,
                name: 'MacBook Air M3',
                category: 'Laptop',
                price: 28990000,
                image: 'https://placehold.co/300x200?text=MacBook+Air+M3',
                description: 'MacBook Air với chip M3 siêu mạnh',
                stock: 8,
                featured: false
            },
            {
                id: 4,
                name: 'AirPods Pro 2',
                category: 'Phụ kiện',
                price: 6490000,
                image: 'https://placehold.co/300x200?text=AirPods+Pro+2',
                description: 'Tai nghe AirPods Pro 2 với khử tiếng ồn',
                stock: 25,
                featured: true
            },
            {
                id: 5,
                name: 'iPad Pro 12.9',
                category: 'Tablet',
                price: 24990000,
                image: 'https://placehold.co/300x200?text=iPad+Pro+12.9',
                description: 'iPad Pro 12.9 inch với chip M2',
                stock: 12,
                featured: false
            }
        ];

        // Demo orders data
        let orders = [];
        let reviews = [];

        // Global variables
        let cart = [];
        let currentUser = null;
        let isAdmin = false;
        let filteredProducts = [...products];

        // ==================== UTILITY FUNCTIONS ====================
        
        // Format số tiền VND
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Generate random order code
        function generateOrderCode() {
            return 'DH' + Date.now().toString().substr(-8) + Math.floor(Math.random() * 100);
        }

        // Format date
        function formatDate(date) {
            return new Intl.DateTimeFormat('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }

        // Show loading spinner
        function showLoading(show = true) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        // Show notification
        function showNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // ==================== PAGE NAVIGATION ====================
        
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId + 'Page').classList.add('active');
            
            // Update page content based on pageId
            switch(pageId) {
                case 'home':
                    loadFeaturedProducts();
                    break;
                case 'products':
                    loadProducts();
                    loadCategories();
                    break;
                case 'cart':
                    loadCartPage();
                    break;
                case 'checkout':
                    loadCheckoutPage();
                    break;
                case 'tracking':
                    document.getElementById('trackingInput').value = '';
                    document.getElementById('trackingResult').style.display = 'none';
                    break;
                case 'admin':
                    if (isAdmin) {
                        loadAdminDashboard();
                    } else {
                        showNotification('Bạn không có quyền truy cập trang này!', 'danger');
                        showPage('home');
                    }
                    break;
            }
        }

        function toggleAdmin() {
            const password = prompt('Nhập mật khẩu admin:');
            if (password === 'admin123') {
                isAdmin = true;
                document.getElementById('adminLink').style.display = 'block';
                showNotification('Đăng nhập admin thành công!', 'success');
                showPage('admin');
            } else if (password !== null) {
                showNotification('Mật khẩu không chính xác!', 'danger');
            }
        }

        // ==================== GOOGLE SHEETS API FUNCTIONS ====================
        
        // Gọi Google Apps Script để lấy dữ liệu sản phẩm
        async function fetchProductsFromGoogleSheets() {
            try {
                showLoading(true);
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getProducts`);
                const data = await response.json();
                
                if (data.success) {
                    products = data.products;
                    filteredProducts = [...products];
                    showLoading(false);
                    return products;
                } else {
                    throw new Error(data.message || 'Lỗi khi tải sản phẩm');
                }
            } catch (error) {
                console.error('Error fetching products:', error);
                showLoading(false);
                showNotification('Không thể tải dữ liệu sản phẩm. Sử dụng dữ liệu demo.', 'warning');
                return products; // Fallback to demo data
            }
        }

        // Gửi đơn hàng lên Google Sheets
        async function submitOrderToGoogleSheets(orderData) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'createOrder',
                        data: orderData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    return result;
                } else {
                    throw new Error(result.message || 'Lỗi khi tạo đơn hàng');
                }
            } catch (error) {
                console.error('Error submitting order:', error);
                // Fallback: save to demo data
                orders.push(orderData);
                return { success: true, orderCode: orderData.orderCode };
            }
        }

        // Tra cứu đơn hàng từ Google Sheets
        async function fetchOrderFromGoogleSheets(orderCode) {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getOrder&orderCode=${orderCode}`);
                const data = await response.json();
                
                if (data.success) {
                    return data.order;
                } else {
                    throw new Error(data.message || 'Không tìm thấy đơn hàng');
                }
            } catch (error) {
                console.error('Error fetching order:', error);
                // Fallback: search in demo data
                return orders.find(order => order.orderCode === orderCode);
            }
        }

        // ==================== PRODUCT FUNCTIONS ====================
        
        function loadFeaturedProducts() {
            const featuredProducts = products.filter(product => product.featured).slice(0, 4);
            const container = document.getElementById('featuredProducts');
            
            container.innerHTML = featuredProducts.map(product => `
                <div class="col-md-3 mb-4">
                    <div class="card product-card h-100">
                        <img src="${product.image}" class="card-img-top product-image" alt="${product.name}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${product.name}</h5>
                            <p class="card-text text-muted small">${product.description}</p>
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="h5 text-primary mb-0">${formatCurrency(product.price)}</span>
                                    <small class="text-muted">Còn ${product.stock}</small>
                                </div>
                                <button class="btn btn-primary w-100" onclick="addToCart(${product.id})">
                                    <i class="bi bi-cart-plus"></i> Thêm vào giỏ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadProducts() {
            displayProducts(filteredProducts);
        }

        function displayProducts(productsToShow) {
            const container = document.getElementById('productsGrid');
            
            if (productsToShow.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="bi bi-search" style="font-size: 3rem; color: #6c757d;"></i>
                            <h4 class="mt-3 text-muted">Không tìm thấy sản phẩm nào</h4>
                            <p class="text-muted">Vui lòng thử lại với từ khóa khác</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = productsToShow.map(product => `
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="card product-card h-100">
                        <img src="${product.image}" class="card-img-top product-image" alt="${product.name}">
                        <div class="card-body d-flex flex-column">
                            <span class="badge bg-secondary mb-2 align-self-start">${product.category}</span>
                            <h5 class="card-title">${product.name}</h5>
                            <p class="card-text text-muted small flex-grow-1">${product.description}</p>
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="h5 text-primary mb-0">${formatCurrency(product.price)}</span>
                                    <small class="text-muted">Còn ${product.stock}</small>
                                </div>
                                <button class="btn btn-primary w-100 ${product.stock === 0 ? 'disabled' : ''}" 
                                        onclick="addToCart(${product.id})" 
                                        ${product.stock === 0 ? 'disabled' : ''}>
                                    <i class="bi bi-cart-plus"></i> 
                                    ${product.stock === 0 ? 'Hết hàng' : 'Thêm vào giỏ'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadCategories() {
            const categories = [...new Set(products.map(product => product.category))];
            const categoryFilter = document.getElementById('categoryFilter');
            
            categoryFilter.innerHTML = '<option value="">Tất cả</option>' + 
                categories.map(category => `<option value="${category}">${category}</option>`).join('');
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
            const sortBy = document.getElementById('sortBy').value;

            // Filter products
            filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                                    product.description.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                const matchesPrice = product.price >= minPrice && product.price <= maxPrice;
                
                return matchesSearch && matchesCategory && matchesPrice;
            });

            // Sort products
            switch(sortBy) {
                case 'name':
                    filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'price-asc':
                    filteredProducts.sort((a, b) => a.price - b.price);
                    break;
                case 'price-desc':
                    filteredProducts.sort((a, b) => b.price - a.price);
                    break;
            }

            displayProducts(filteredProducts);
        }

        // Setup search on input
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    filterProducts();
                }
            });
        });

        // ==================== CART FUNCTIONS ====================
        
        function loadCart() {
            const savedCart = localStorage.getItem('shopping_cart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }
            updateCartBadge();
        }

        function saveCart() {
            localStorage.setItem('shopping_cart', JSON.stringify(cart));
            updateCartBadge();
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock === 0) {
                showNotification('Sản phẩm không có sẵn!', 'warning');
                return;
            }

            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity += 1;
                    showNotification(`Đã tăng số lượng ${product.name}`, 'success');
                } else {
                    showNotification('Không đủ hàng trong kho!', 'warning');
                    return;
                }
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.image,
                    quantity: 1,
                    maxStock: product.stock
                });
                showNotification(`Đã thêm ${product.name} vào giỏ hàng`, 'success');
            }
            
            saveCart();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            saveCart();
            loadCartPage();
            
            const product = products.find(p => p.id === productId);
            showNotification(`Đã xóa ${product.name} khỏi giỏ hàng`, 'info');
        }

        function updateQuantity(productId, newQuantity) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                if (newQuantity <= 0) {
                    removeFromCart(productId);
                } else if (newQuantity <= item.maxStock) {
                    item.quantity = newQuantity;
                    saveCart();
                    loadCartPage();
                } else {
                    showNotification('Số lượng vượt quá tồn kho!', 'warning');
                }
            }
        }

        function updateCartBadge() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartBadge').textContent = totalItems;
        }

        function calculateCartTotal() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = cart.length > 0 ? 30000 : 0;
            return { subtotal, shipping, total: subtotal + shipping };
        }

        function loadCartPage() {
            const cartItems = document.getElementById('cartItems');
            const totals = calculateCartTotal();
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-cart-x" style="font-size: 3rem; color: #6c757d;"></i>
                        <h4 class="mt-3 text-muted">Giỏ hàng trống</h4>
                        <p class="text-muted">Hãy thêm sản phẩm vào giỏ hàng</p>
                        <button class="btn btn-primary" onclick="showPage('products')">
                            Mua sắm ngay
                        </button>
                    </div>
                `;
                document.getElementById('checkoutBtn').disabled = true;
            } else {
                cartItems.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <div class="row align-items-center">
                            <div class="col-2">
                                <img src="${item.image}" class="img-fluid rounded" alt="${item.name}">
                            </div>
                            <div class="col-4">
                                <h6 class="mb-0">${item.name}</h6>
                                <small class="text-muted">${formatCurrency(item.price)}</small>
                            </div>
                            <div class="col-3">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary" type="button" 
                                            onclick="updateQuantity(${item.id}, ${item.quantity - 1})">-</button>
                                    <input type="number" class="form-control text-center" 
                                           value="${item.quantity}" min="1" max="${item.maxStock}"
                                           onchange="updateQuantity(${item.id}, parseInt(this.value))">
                                    <button class="btn btn-outline-secondary" type="button" 
                                            onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                                </div>
                            </div>
                            <div class="col-2">
                                <strong>${formatCurrency(item.price * item.quantity)}</strong>
                            </div>
                            <div class="col-1">
                                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('checkoutBtn').disabled = false;
            }
            
            // Update totals
            document.getElementById('subtotal').textContent = formatCurrency(totals.subtotal);
            document.getElementById('shipping').textContent = formatCurrency(totals.shipping);
            document.getElementById('total').textContent = formatCurrency(totals.total);
        }

        // ==================== CHECKOUT FUNCTIONS ====================
        
        function showCheckout() {
            if (cart.length === 0) {
                showNotification('Giỏ hàng trống!', 'warning');
                return;
            }
            showPage('checkout');
        }

        function loadCheckoutPage() {
            const checkoutItems = document.getElementById('checkoutItems');
            const totals = calculateCartTotal();
            
            // Generate order code for transfer content
            const tempOrderCode = generateOrderCode();
            document.getElementById('transferContent').textContent = `Thanh toán đơn hàng #${tempOrderCode}`;
            
            // Display cart items
            checkoutItems.innerHTML = cart.map(item => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <h6 class="mb-0">${item.name}</h6>
                        <small class="text-muted">x${item.quantity}</small>
                    </div>
                    <span>${formatCurrency(item.price * item.quantity)}</span>
                </div>
            `).join('');
            
            // Update totals
            document.getElementById('checkoutSubtotal').textContent = formatCurrency(totals.subtotal);
            document.getElementById('checkoutTotal').textContent = formatCurrency(totals.total);
        }

        async function confirmPayment() {
            const form = document.getElementById('checkoutForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const orderData = {
                orderCode: generateOrderCode(),
                customerName: document.getElementById('customerName').value,
                customerPhone: document.getElementById('customerPhone').value,
                customerEmail: document.getElementById('customerEmail').value,
                customerAddress: document.getElementById('customerAddress').value,
                orderNote: document.getElementById('orderNote').value,
                items: [...cart],
                totals: calculateCartTotal(),
                orderDate: new Date(),
                status: 'pending'
            };
            
            try {
                showLoading(true);
                const result = await submitOrderToGoogleSheets(orderData);
                
                if (result.success) {
                    // Clear cart
                    cart = [];
                    saveCart();
                    
                    // Show success page
                    document.getElementById('orderCode').textContent = orderData.orderCode;
                    document.getElementById('orderAmount').textContent = formatCurrency(orderData.totals.total);
                    document.getElementById('orderTime').textContent = formatDate(orderData.orderDate);
                    
                    showPage('orderSuccess');
                    showNotification('Đặt hàng thành công!', 'success');
                } else {
                    throw new Error('Lỗi khi tạo đơn hàng');
                }
            } catch (error) {
                console.error('Error creating order:', error);
                showNotification('Có lỗi xảy ra khi đặt hàng. Vui lòng thử lại!', 'danger');
            } finally {
                showLoading(false);
            }
        }

        // ==================== ORDER TRACKING FUNCTIONS ====================
        
        async function trackOrder() {
            const orderCode = document.getElementById('trackingInput').value.trim();
            if (!orderCode) {
                showNotification('Vui lòng nhập mã đơn hàng!', 'warning');
                return;
            }
            
            try {
                showLoading(true);
                const order = await fetchOrderFromGoogleSheets(orderCode);
                
                if (order) {
                    displayOrderTracking(order);
                } else {
                    document.getElementById('trackingResult').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Không tìm thấy đơn hàng với mã: <strong>${orderCode}</strong>
                        </div>
                    `;
                    document.getElementById('trackingResult').style.display = 'block';
                }
            } catch (error) {
                console.error('Error tracking order:', error);
                showNotification('Có lỗi khi tra cứu đơn hàng!', 'danger');
            } finally {
                showLoading(false);
            }
        }

        function displayOrderTracking(order) {
            const canReview = canWriteReview(order);
            const orderReviews = reviews.filter(r => r.orderCode === order.orderCode);
            
            document.getElementById('trackingResult').innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="bi bi-check-circle"></i> Tìm thấy đơn hàng</h5>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5>Thông tin đơn hàng</h5>
                        <p><strong>Mã đơn:</strong> ${order.orderCode}</p>
                        <p><strong>Khách hàng:</strong> ${order.customerName}</p>
                        <p><strong>Điện thoại:</strong> ${order.customerPhone}</p>
                        <p><strong>Địa chỉ:</strong> ${order.customerAddress}</p>
                        <p><strong>Ngày đặt:</strong> ${formatDate(new Date(order.orderDate))}</p>
                        <p><strong>Trạng thái:</strong> 
                            <span class="badge bg-${getStatusColor(order.status)}">${getStatusText(order.status)}</span>
                        </p>
                        <p><strong>Tổng tiền:</strong> ${formatCurrency(order.totals.total)}</p>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Sản phẩm đã đặt</h5>
                        ${order.items.map(item => `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                <div>
                                    <strong>${item.name}</strong><br>
                                    <small>x${item.quantity}</small>
                                </div>
                                <span>${formatCurrency(item.price * item.quantity)}</span>
                            </div>
                        `).join('')}
                        
                        ${order.status === 'completed' ? `
                            <div class="mt-3">
                                <button class="btn btn-success btn-sm" onclick="confirmDelivery('${order.orderCode}')">
                                    <i class="bi bi-check-circle"></i> Xác nhận đã nhận hàng
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                ${canReview ? `
                    <div class="mt-4">
                        <h5>Đánh giá sản phẩm</h5>
                        <form onsubmit="submitReview(event, '${order.orderCode}')">
                            <div class="mb-3">
                                <label class="form-label">Chọn sản phẩm để đánh giá:</label>
                                <select class="form-select" id="reviewProduct" required>
                                    <option value="">-- Chọn sản phẩm --</option>
                                    ${order.items.map(item => `
                                        <option value="${item.id}">${item.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Đánh giá:</label>
                                <div class="d-flex">
                                    ${[1,2,3,4,5].map(star => `
                                        <i class="bi bi-star review-star" data-rating="${star}" 
                                           onclick="setRating(${star})" style="cursor: pointer; font-size: 1.5rem; margin-right: 5px;"></i>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="reviewRating" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nhận xét:</label>
                                <textarea class="form-control" id="reviewComment" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
                        </form>
                    </div>
                ` : ''}
                
                ${orderReviews.length > 0 ? `
                    <div class="mt-4">
                        <h5>Đánh giá đã gửi</h5>
                        ${orderReviews.map(review => `
                            <div class="review-card">
                                <div class="d-flex justify-content-between">
                                    <strong>${products.find(p => p.id === review.productId)?.name}</strong>
                                    <div class="stars">
                                        ${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}
                                    </div>
                                </div>
                                <p class="mb-1">${review.comment}</p>
                                <small class="text-muted">${formatDate(new Date(review.reviewDate))}</small>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
            
            document.getElementById('trackingResult').style.display = 'block';
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'processing': 'info',
                'shipped': 'primary',
                'completed': 'success',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'Chờ xử lý',
                'processing': 'Đang xử lý',
                'shipped': 'Đã giao',
                'completed': 'Hoàn thành',
                'cancelled': 'Đã hủy'
            };
            return texts[status] || 'Không xác định';
        }

        function canWriteReview(order) {
            // Cho phép review trong vòng 1 tuần sau khi nhận hàng
            if (order.status !== 'completed' || !order.deliveryConfirmedDate) {
                return false;
            }
            
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            return new Date(order.deliveryConfirmedDate) > oneWeekAgo;
        }

        function confirmDelivery(orderCode) {
            if (confirm('Xác nhận bạn đã nhận được hàng?')) {
                // Update order status
                const order = orders.find(o => o.orderCode === orderCode);
                if (order) {
                    order.deliveryConfirmedDate = new Date();
                    showNotification('Đã xác nhận nhận hàng thành công!', 'success');
                    trackOrder(); // Refresh tracking display
                }
            }
        }

        function setRating(rating) {
            document.getElementById('reviewRating').value = rating;
            
            // Update star display
            document.querySelectorAll('.review-star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('bi-star');
                    star.classList.add('bi-star-fill');
                    star.style.color = '#ffc107';
                } else {
                    star.classList.remove('bi-star-fill');
                    star.classList.add('bi-star');
                    star.style.color = '#6c757d';
                }
            });
        }

        function submitReview(event, orderCode) {
            event.preventDefault();
            
            const productId = parseInt(document.getElementById('reviewProduct').value);
            const rating = parseInt(document.getElementById('reviewRating').value);
            const comment = document.getElementById('reviewComment').value;
            
            const review = {
                orderCode: orderCode,
                productId: productId,
                rating: rating,
                comment: comment,
                reviewDate: new Date(),
                customerName: orders.find(o => o.orderCode === orderCode)?.customerName
            };
            
            reviews.push(review);
            showNotification('Gửi đánh giá thành công!', 'success');
            
            // Refresh tracking display
            trackOrder();
        }

        // ==================== ADMIN FUNCTIONS ====================
        
        function loadAdminDashboard() {
            updateAdminStats();
            loadAdminOrders();
        }

        function updateAdminStats() {
            const totalOrders = orders.length;
            const thisMonth = new Date();
            thisMonth.setDate(1);
            thisMonth.setHours(0, 0, 0, 0);
            
            const monthlyOrders = orders.filter(order => new Date(order.orderDate) >= thisMonth);
            const totalRevenue = monthlyOrders.reduce((sum, order) => sum + order.totals.total, 0);
            const pendingOrders = orders.filter(order => order.status === 'pending').length;
            const totalProducts = products.length;
            
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('pendingOrders').textContent = pendingOrders;
            document.getElementById('totalProducts').textContent = totalProducts;
        }

        function loadAdminOrders() {
            const statusFilter = document.getElementById('orderStatusFilter').value;
            let filteredOrders = orders;
            
            if (statusFilter) {
                filteredOrders = orders.filter(order => order.status === statusFilter);
            }
            
            const tableBody = document.getElementById('adminOrdersTable');
            tableBody.innerHTML = filteredOrders.map(order => `
                <tr>
                    <td><strong>${order.orderCode}</strong></td>
                    <td>
                        ${order.customerName}<br>
                        <small class="text-muted">${order.customerPhone}</small>
                    </td>
                    <td>
                        ${order.items.map(item => `${item.name} (x${item.quantity})`).join('<br>')}
                    </td>
                    <td><strong>${formatCurrency(order.totals.total)}</strong></td>
                    <td>
                        <select class="form-select form-select-sm" onchange="updateOrderStatus('${order.orderCode}', this.value)">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Chờ xử lý</option>
                            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Đang xử lý</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Đã giao</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Hoàn thành</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Đã hủy</option>
                        </select>
                    </td>
                    <td>${formatDate(new Date(order.orderDate))}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${order.orderCode}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteOrder('${order.orderCode}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateOrderStatus(orderCode, newStatus) {
            const order = orders.find(o => o.orderCode === orderCode);
            if (order) {
                order.status = newStatus;
                showNotification(`Đã cập nhật trạng thái đơn hàng ${orderCode}`, 'success');
                updateAdminStats();
            }
        }

        function viewOrderDetails(orderCode) {
            const order = orders.find(o => o.orderCode === orderCode);
            if (!order) return;
            
            const modalContent = `
                <div class="modal fade" id="orderDetailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Chi tiết đơn hàng ${order.orderCode}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Thông tin khách hàng</h6>
                                        <p><strong>Tên:</strong> ${order.customerName}</p>
                                        <p><strong>Điện thoại:</strong> ${order.customerPhone}</p>
                                        <p><strong>Email:</strong> ${order.customerEmail || 'Không có'}</p>
                                        <p><strong>Địa chỉ:</strong> ${order.customerAddress}</p>
                                        ${order.orderNote ? `<p><strong>Ghi chú:</strong> ${order.orderNote}</p>` : ''}
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Thông tin đơn hàng</h6>
                                        <p><strong>Ngày đặt:</strong> ${formatDate(new Date(order.orderDate))}</p>
                                        <p><strong>Trạng thái:</strong> <span class="badge bg-${getStatusColor(order.status)}">${getStatusText(order.status)}</span></p>
                                        <p><strong>Tổng tiền:</strong> ${formatCurrency(order.totals.total)}</p>
                                    </div>
                                </div>
                                <hr>
                                <h6>Sản phẩm đặt mua</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Sản phẩm</th>
                                                <th>Đơn giá</th>
                                                <th>Số lượng</th>
                                                <th>Thành tiền</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${order.items.map(item => `
                                                <tr>
                                                    <td>${item.name}</td>
                                                    <td>${formatCurrency(item.price)}</td>
                                                    <td>${item.quantity}</td>
                                                    <td>${formatCurrency(item.price * item.quantity)}</td>
                                                </tr>
                                            `).join('')}
                                            <tr>
                                                <td colspan="3"><strong>Phí vận chuyển</strong></td>
                                                <td><strong>${formatCurrency(order.totals.shipping)}</strong></td>
                                            </tr>
                                            <tr class="table-success">
                                                <td colspan="3"><strong>Tổng cộng</strong></td>
                                                <td><strong>${formatCurrency(order.totals.total)}</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('orderDetailModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalContent);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();
        }

        function deleteOrder(orderCode) {
            if (confirm(`Bạn có chắc chắn muốn xóa đơn hàng ${orderCode}?`)) {
                orders = orders.filter(o => o.orderCode !== orderCode);
                showNotification(`Đã xóa đơn hàng ${orderCode}`, 'success');
                loadAdminOrders();
                updateAdminStats();
            }
        }

        function generateStats() {
            const fromDate = new Date(document.getElementById('statsFromDate').value);
            const toDate = new Date(document.getElementById('statsToDate').value);
            
            if (!fromDate || !toDate) {
                showNotification('Vui lòng chọn khoảng thời gian!', 'warning');
                return;
            }
            
            if (fromDate > toDate) {
                showNotification('Ngày bắt đầu không thể lớn hơn ngày kết thúc!', 'warning');
                return;
            }
            
            const filteredOrders = orders.filter(order => {
                const orderDate = new Date(order.orderDate);
                return orderDate >= fromDate && orderDate <= toDate;
            });
            
            const totalOrders = filteredOrders.length;
            const totalRevenue = filteredOrders.reduce((sum, order) => sum + order.totals.total, 0);
            const completedOrders = filteredOrders.filter(order => order.status === 'completed').length;
            
            const statsModal = `
                <div class="modal fade" id="statsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Báo cáo thống kê</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <h6>Thời gian: ${formatDate(fromDate)} - ${formatDate(toDate)}</h6>
                                <hr>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="border rounded p-3">
                                            <h4 class="text-primary">${totalOrders}</h4>
                                            <small>Tổng đơn hàng</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-3">
                                            <h4 class="text-success">${formatCurrency(totalRevenue)}</h4>
                                            <small>Tổng doanh thu</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-3">
                                            <h4 class="text-info">${completedOrders}</h4>
                                            <small>Đơn hoàn thành</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <h6>Sản phẩm bán chạy</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Sản phẩm</th>
                                                    <th>Số lượng bán</th>
                                                    <th>Doanh thu</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${getTopSellingProducts(filteredOrders).map(item => `
                                                    <tr>
                                                        <td>${item.name}</td>
                                                        <td>${item.quantity}</td>
                                                        <td>${formatCurrency(item.revenue)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('statsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', statsModal);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('statsModal'));
            modal.show();
        }

        function getTopSellingProducts(orders) {
            const productStats = {};
            
            orders.forEach(order => {
                order.items.forEach(item => {
                    if (!productStats[item.id]) {
                        productStats[item.id] = {
                            name: item.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    productStats[item.id].quantity += item.quantity;
                    productStats[item.id].revenue += item.price * item.quantity;
                });
            });
            
            return Object.values(productStats)
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 5);
        }

        // ==================== INITIALIZATION ====================
        
        async function initializeApp() {
            // Load cart from localStorage
            loadCart();
            
            // Load products from Google Sheets (fallback to demo data)
            await fetchProductsFromGoogleSheets();
            
            // Initialize default page
            showPage('home');
            
            // Set up event listeners
            setupEventListeners();
            
            // Set default date range for admin stats
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('statsFromDate').value = firstDayOfMonth.toISOString().split('T')[0];
            document.getElementById('statsToDate').value = today.toISOString().split('T')[0];
        }

        function setupEventListeners() {
            // Search input enter key
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterProducts();
                }
            });
            
            // Tracking input enter key
            document.getElementById('trackingInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    trackOrder();
                }
            });
            
            // Auto-filter when inputs change
            ['searchInput', 'categoryFilter', 'minPrice', 'maxPrice', 'sortBy'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', filterProducts);
                }
            });
        }

        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);

        // ==================== GOOGLE APPS SCRIPT CODE ====================
        /*
        Đây là code Google Apps Script cần tạo để làm backend:
        
        // Code.gs
        function doGet(e) {
            const action = e.parameter.action;
            
            switch(action) {
                case 'getProducts':
                    return getProducts();
                case 'getOrder':
                    return getOrder(e.parameter.orderCode);
                default:
                    return ContentService.createTextOutput(JSON.stringify({
                        success: false,
                        message: 'Invalid action'
                    })).setMimeType(ContentService.MimeType.JSON);
            }
        }

        function doPost(e) {
            const data = JSON.parse(e.postData.contents);
            const action = data.action;
            
            switch(action) {
                case 'createOrder':
                    return createOrder(data.data);
                case 'updateOrderStatus':
                    return updateOrderStatus(data.orderCode, data.status);
                default:
                    return ContentService.createTextOutput(JSON.stringify({
                        success: false,
                        message: 'Invalid action'
                    })).setMimeType(ContentService.MimeType.JSON);
            }
        }

        function getProducts() {
            try {
                const sheet = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID').getSheetByName('Products');
                const data = sheet.getDataRange().getValues();
                const headers = data[0];
                const products = [];
                
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    const product = {};
                    headers.forEach((header, index) => {
                        product[header] = row[index];
                    });
                    products.push(product);
                }
                
                return ContentService.createTextOutput(JSON.stringify({
                    success: true,
                    products: products
                })).setMimeType(ContentService.MimeType.JSON);
            } catch (error) {
                return ContentService.createTextOutput(JSON.stringify({
                    success: false,
                    message: error.toString()
                })).setMimeType(ContentService.MimeType.JSON);
            }
        }

        function createOrder(orderData) {
            try {
                const sheet = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID').getSheetByName('Orders');
                
                // Add order to sheet
                sheet.appendRow([
                    orderData.orderCode,
                    orderData.customerName,
                    orderData.customerPhone,
                    orderData.customerEmail,
                    orderData.customerAddress,
                    orderData.orderNote,
                    JSON.stringify(orderData.items),
                    orderData.totals.subtotal,
                    orderData.totals.shipping,
                    orderData.totals.total,
                    new Date(orderData.orderDate),
                    orderData.status
                ]);
                
                return ContentService.createTextOutput(JSON.stringify({
                    success: true,
                    orderCode: orderData.orderCode
                })).setMimeType(ContentService.MimeType.JSON);
            } catch (error) {
                return ContentService.createTextOutput(JSON.stringify({
                    success: false,
                    message: error.toString()
                })).setMimeType(ContentService.MimeType.JSON);
            }
        }

        function getOrder(orderCode) {
            try {
                const sheet = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID').getSheetByName('Orders');
                const data = sheet.getDataRange().getValues();
                
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (row[0] === orderCode) {
                        const order = {
                            orderCode: row[0],
                            customerName: row[1],
                            customerPhone: row[2],
                            customerEmail: row[3],
                            customerAddress: row[4],
                            orderNote: row[5],
                            items: JSON.parse(row[6]),
                            totals: {
                                subtotal: row[7],
                                shipping: row[8],
                                total: row[9]
                            },
                            orderDate: row[10],
                            status: row[11]
                        };
                        
                        return ContentService.createTextOutput(JSON.stringify({
                            success: true,
                            order: order
                        })).setMimeType(ContentService.MimeType.JSON);
                    }
                }
                
                return ContentService.createTextOutput(JSON.stringify({
                    success: false,
                    message: 'Order not found'
                })).setMimeType(ContentService.MimeType.JSON);
            } catch (error) {
                return ContentService.createTextOutput(JSON.stringify({
                    success: false,
                    message: error.toString()
                })).setMimeType(ContentService.MimeType.JSON);
            }
        }
        */

    </script>
</body>
</html>
