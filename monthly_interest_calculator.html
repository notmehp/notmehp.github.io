<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Máy Tính Lãi Gửi Trong Tháng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container py-5">
  <h2 class="mb-4">Máy Tính Lãi Gửi Theo Ngày (FIFO)</h2>

  <!-- Control Panel -->
  <form id="txForm" class="row g-3">
    <div class="col-md-2">
      <input type="date" class="form-control" id="txDate" required />
    </div>
    <div class="col-md-2">
      <input type="number" class="form-control" id="txAmount" placeholder="Số tiền" required />
    </div>
    <div class="col-md-2">
      <select class="form-select" id="txType">
        <option value="deposit">Gửi</option>
        <option value="withdraw">Rút</option>
      </select>
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" id="txNote" placeholder="Ghi chú" />
    </div>
    <div class="col-md-1">
      <button type="submit" class="btn btn-primary w-100">Thêm</button>
    </div>
  </form>

  <!-- Settings -->
  <div class="row g-3 align-items-center mt-3">
    <div class="col-auto">
      <label class="col-form-label">Tháng:</label>
    </div>
    <div class="col-auto">
      <input type="number" id="monthSelect" class="form-control" min="1" max="12" value="7">
    </div>
    <div class="col-auto">
      <label class="col-form-label">Năm:</label>
    </div>
    <div class="col-auto">
      <input type="number" id="yearSelect" class="form-control" min="2000" value="2025">
    </div>
    <div class="col-auto">
      <label class="col-form-label">Lãi suất (%/năm):</label>
    </div>
    <div class="col-auto">
      <input type="number" id="interestRate" class="form-control" value="5" step="0.1">
    </div>
    <div class="col-auto">
      <button class="btn btn-success" onclick="updateResults()">Tính lại</button>
    </div>
  </div>

  <!-- Table -->
  <table class="table table-striped mt-4" id="txTable">
    <thead>
      <tr>
        <th>Ngày</th>
        <th>Loại</th>
        <th>Số tiền</th>
        <th>Ghi chú</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Kết quả -->
  <div class="mt-4">
    <h5>Lãi trong tháng: <span id="interestTotal">0</span> VND</h5>
    <h5>Số dư cuối kỳ: <span id="balanceEnd">0</span> VND</h5>
  </div>
</div>

<script>
let transactions = JSON.parse(localStorage.getItem('transactions')) || [];

function saveData() {
  localStorage.setItem('transactions', JSON.stringify(transactions));
}

function renderTable() {
  const tbody = document.querySelector("#txTable tbody");
  tbody.innerHTML = "";
  transactions.forEach(tx => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="date" value="${tx.date}" class="form-control form-control-sm" onchange="editTx(${tx.id}, 'date', this.value)" /></td>
      <td>
        <select class="form-select form-select-sm" onchange="editTx(${tx.id}, 'type', this.value)">
          <option value="deposit" ${tx.type === 'deposit' ? 'selected' : ''}>Gửi</option>
          <option value="withdraw" ${tx.type === 'withdraw' ? 'selected' : ''}>Rút</option>
        </select>
      </td>
      <td><input type="number" class="form-control form-control-sm" value="${tx.amount}" onchange="editTx(${tx.id}, 'amount', this.value)" /></td>
      <td><input type="text" class="form-control form-control-sm" value="${tx.note}" onchange="editTx(${tx.id}, 'note', this.value)" /></td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteTx(${tx.id})">X</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function editTx(id, field, value) {
  const tx = transactions.find(t => t.id === id);
  if (tx) {
    tx[field] = field === 'amount' ? Number(value) : value;
    saveData();
    updateResults();
  }
}

function deleteTx(id) {
  transactions = transactions.filter(tx => tx.id !== id);
  saveData();
  renderTable();
  updateResults();
}

function updateResults() {
  const month = Number(document.getElementById('monthSelect').value);
  const year = Number(document.getElementById('yearSelect').value);
  const rate = Number(document.getElementById('interestRate').value);

  const interest = calculateInterestFIFO(transactions, rate, month, year);
  document.getElementById("interestTotal").textContent = interest.toLocaleString();

  const depositSum = transactions.filter(t => t.type === 'deposit').reduce((sum, t) => sum + t.amount, 0);
  const withdrawSum = transactions.filter(t => t.type === 'withdraw').reduce((sum, t) => sum + t.amount, 0);
  const balance = depositSum - withdrawSum;
  document.getElementById("balanceEnd").textContent = balance.toLocaleString();
}

function calculateInterestFIFO(transactions, annualRate, month, year) {
  const deposits = [];
  const endDate = new Date(year, month, 0);
  const interestRatePerDay = annualRate / 100 / 365;
  let totalInterest = 0;

  const txs = [...transactions].filter(tx => {
    const d = new Date(tx.date);
    return d.getMonth() + 1 === month && d.getFullYear() === year;
  }).sort((a, b) => new Date(a.date) - new Date(b.date));

  txs.forEach(tx => {
    const txDate = new Date(tx.date);
    if (tx.type === 'deposit') {
      deposits.push({ amount: tx.amount, date: txDate });
    } else if (tx.type === 'withdraw') {
      let remaining = tx.amount;
      for (let i = 0; i < deposits.length && remaining > 0; i++) {
        const dep = deposits[i];
        if (dep.amount === 0) continue;
        const used = Math.min(dep.amount, remaining);
        const days = Math.max(0, (txDate - dep.date) / (1000 * 60 * 60 * 24));
        totalInterest += used * interestRatePerDay * days;
        dep.amount -= used;
        remaining -= used;
      }
    }
  });

  deposits.forEach(dep => {
    if (dep.amount > 0) {
      const days = Math.max(0, (endDate - dep.date) / (1000 * 60 * 60 * 24));
      totalInterest += dep.amount * interestRatePerDay * days;
    }
  });

  return Math.round(totalInterest);
}

// Initial Load
renderTable();
updateResults();

document.getElementById("txForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const tx = {
    id: Date.now(),
    date: document.getElementById("txDate").value,
    amount: Number(document.getElementById("txAmount").value),
    type: document.getElementById("txType").value,
    note: document.getElementById("txNote").value
  };
  transactions.push(tx);
  saveData();
  this.reset();
  renderTable();
  updateResults();
});
</script>
</body>
</html>
