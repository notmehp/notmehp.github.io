<!DOCTYPE html>
<!-- Trình Theo dõi Giao dịch & Tính Lãi Theo Tháng -->
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tính Lãi Gửi Tiết Kiệm Theo Tháng</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; }
    .table-container { max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Theo dõi Giao dịch & Tính Lãi</h1>
    <!-- Cài đặt lãi suất -->
    <div class="mb-4">
      <label for="interestRate" class="form-label">Lãi suất năm (%)</label>
      <input type="number" id="interestRate" class="form-control" placeholder="Ví dụ: 6" step="0.01" value="6">
      <small class="form-text text-muted">Nhập lãi suất danh nghĩa hàng năm để tính lãi hàng ngày.</small>
    </div>

    <!-- Form giao dịch -->
    <form id="txnForm" class="row g-3 mb-4">
      <div class="col-md-4">
        <label for="txnDate" class="form-label">Ngày</label>
        <input type="date" id="txnDate" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label for="txnType" class="form-label">Loại giao dịch</label>
        <select id="txnType" class="form-select" required>
          <option value="deposit">Nộp tiền</option>
          <option value="withdraw">Rút tiền</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="txnAmount" class="form-label">Số tiền (VND)</label>
        <input type="number" id="txnAmount" class="form-control" placeholder="Ví dụ: 5500000000" required>
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn-primary">Thêm giao dịch</button>
      </div>
    </form>

    <!-- Lịch sử giao dịch -->
    <div class="table-container mb-4">
      <table class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>Ngày</th>
            <th>Loại</th>
            <th>Số tiền (VND)</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>

    <!-- Kết quả -->
    <div class="mb-4">
      <button id="calcBtn" class="btn btn-success me-2">Tính lãi & Số dư cuối tháng</button>
      <button id="exportBtn" class="btn btn-outline-secondary">Xuất PDF</button>
    </div>
    <div id="results" class="border p-3" style="display:none;">
      <p><strong>Tổng tiền lãi:</strong> <span id="totalInterest"></span> VND</p>
      <p><strong>Số dư cuối tháng:</strong> <span id="endBalance"></span> VND</p>
    </div>
  </div>

  <!-- Bootstrap & Dependencies JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // State
    const transactions = [];

    // Helpers
    function formatCurrency(num) {
      return num.toLocaleString('vi-VN');
    }

    // Thêm giao dịch
    document.getElementById('txnForm').addEventListener('submit', e => {
      e.preventDefault();
      const date = document.getElementById('txnDate').value;
      const type = document.getElementById('txnType').value;
      const amount = parseFloat(document.getElementById('txnAmount').value);
      transactions.push({ date: new Date(date), type, amount });
      transactions.sort((a,b) => a.date - b.date);
      renderHistory();
      e.target.reset();
    });

    // Hiển thị lịch sử
    function renderHistory() {
      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = '';
      transactions.forEach(txn => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${txn.date.toISOString().slice(0,10)}</td>
          <td>${txn.type === 'deposit' ? 'Nộp tiền' : 'Rút tiền'}</td>
          <td>${formatCurrency(txn.amount)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Tính lãi & số dư
    document.getElementById('calcBtn').addEventListener('click', () => {
      if (!transactions.length) return alert('Chưa có giao dịch.');
      const rateAnnual = parseFloat(document.getElementById('interestRate').value) / 100;
      const rateDaily = rateAnnual / 365;
      const year = new Date(transactions[0].date).getFullYear();
      const month = new Date(transactions[0].date).getMonth();
      let totalInterest = 0;
      let balance = 0;
      let prevDate = new Date(year, month, 1);

      transactions.forEach(txn => {
        const currDate = new Date(txn.date);
        if (currDate.getMonth() !== month || currDate.getFullYear() !== year) return;
        const diffDays = Math.floor((currDate - prevDate) / (1000*60*60*24));
        if (diffDays > 0) totalInterest += balance * diffDays * rateDaily;
        balance += (txn.type === 'deposit' ? txn.amount : -txn.amount);
        prevDate = new Date(currDate);
      });

      const lastDay = new Date(year, month+1, 0);
      const remDays = Math.floor((lastDay - prevDate) / (1000*60*60*24));
      if (remDays > 0) totalInterest += balance * remDays * rateDaily;

      document.getElementById('totalInterest').innerText = formatCurrency(Math.round(totalInterest));
      document.getElementById('endBalance').innerText = formatCurrency(balance);
      document.getElementById('results').style.display = 'block';
    });

    // Xuất PDF (in trang hiện tại)
    document.getElementById('exportBtn').addEventListener('click', () => {
      window.print();
    });
  </script>
</body>
</html>
